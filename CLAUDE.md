# Fractal Code — Claude Code Instructions

This file instructs Claude Code sessions working on this repository.

## The Four Cell Types

Every component you create must be one of these:

| Type | When to Use |
|------|-------------|
| **Transformer** | Stateless computation: takes input, produces output |
| **Reactor** | Event-driven: listens for events, triggers responses |
| **Keeper** | State management: persists data over time |
| **Channel** | Data transport: moves data between cells |

If what you're building doesn't fit one of these, rethink your design. It must fit.

## Universal Contract

Every cell must implement ALL of these — no exceptions:

1. **Identity** — `{ name, cellType, version }`
2. **Input** — schema of what it accepts
3. **Output** — schema of what it produces
4. **Health & Circuit Breaker** — `health()` method returning status + `budgetRemaining`. Transformers and Reactors must accept `complexityBudget` and decrement on each execution. Auto-degrades to `"safe-mode"` at zero.
5. **Lineage (Intent Ledger)** — structured record, NOT vague text:
   ```typescript
   {
     source: string;        // Agent ID (e.g., "Claude-Opus-4.6")
     trigger: string;       // Prompt ID, Issue #, or Decision Record
     justification: string; // One sentence of structural necessity
     signature: string;     // Merkle hash of parent context at creation
   }
   ```
6. **Signature** — Merkle-based structural fingerprint (auto-generated by SDK)

## Composition Rules

- Cells may contain sub-cells
- **All inter-cell communication MUST pass through Channels** — no direct references between siblings
- No shared global state, no implicit dependencies, no side channels
- From the outside, a composed cell looks identical to a simple cell (same contract)
- **Principle XI:** Channel isolation is strict in source code (Design Time); the compiler may optimize to direct calls at Run Time

## File Naming Convention

```
<name>.<cell-type>.ts
```

Examples:
- `parser.transformer.ts`
- `queue.channel.ts`
- `events.reactor.ts`
- `cache.keeper.ts`

## Before Committing

1. Ensure every new component includes a **proper Intent Ledger** (source, trigger, justification, signature)
2. Ensure Transformers and Reactors have **circuit breaker** (`complexityBudget`)
3. Run the constitutional validator: `cd validator && npx fractal-validate <path>`
4. All eight checks must pass: cell-type, contract, composition, self-similarity, context-map, signature, circuit-breaker, intent-ledger

## Branch Naming

```
agent/claude/<feature-description>
```

## Key Principle

The structure is fractal — self-similar at every scale. A single function and a distributed system of 10,000 components present the same contract. If you're breaking this pattern, you're breaking the constitution.
